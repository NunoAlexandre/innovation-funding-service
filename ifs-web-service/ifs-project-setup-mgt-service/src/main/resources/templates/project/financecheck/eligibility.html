<!DOCTYPE html>
<html class="no-js" lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <div th:include="fragments/layout :: head" th:with="pageTitle='Eligibility'" th:remove="tag" />
</head>

<body th:with="context='project-management'" class="eligibility-form">
<div th:include="fragments/modals :: modal-overlay" th:remove="tag"/>

<div th:include="fragments/layout :: body-start" th:remove="tag" />
<div th:include="fragments/layout :: global-header" th:remove="tag" />

<main id="content">
    <div th:include="fragments/layout :: main-content-start" th:remove="tag" />
    <div th:include="fragments/layout :: header-sub" th:with="linkTitle='Finance checks',linkClass='link-back',linkUrl=@{/project/{projectId}/finance-check(projectId=${model.projectId})},currentCompetition=null"  />

    <div class="page-title">
        <div th:include="fragments/elements :: project-title (projectId=${model.projectId}, projectName=${model.projectName})" th:remove="tag" />
        <h1 class="heading-xlarge">
            <th:block th:text="${model.organisationName}" />
            <small th:if="${model.leadPartnerOrganisation}">(Lead Partner)</small>
        </h1>
    </div>

    <th:block th:if="${model.isShowApprovalMessage()}">
        <div class="success-alert">
            <p>The partner's finance eligibility has been approved by <span th:text="${model.getApproverName()}"/>, <span th:text="${#temporals.format(model.getApprovalDate(), 'd MMMM yyyy')}"/></p>
        </div>
    </th:block>

    <h2 class="heading-medium">Finances Overview</h2>
    <div class="table-overflow">
        <table class="table-overview">
            <thead>
            <tr>
                <th scope="col">Project duration</th>
                <th scope="col">Total costs</th>
                <th scope="col" class="numeric">% grant</th>
                <th scope="col" class="numeric">Funding sought</th>
                <th scope="col" class="numeric">Other public sector funding</th>
                <th scope="col" class="numeric">Contribution to project</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td th:text="${model.eligibilityOverview.durationInMonths+' months'}" />
                <td class="numeric">&pound; <th:block th:text="${#numbers.formatInteger(model.eligibilityOverview.totalCost,1,'COMMA')}" /></td>
                <td class="numeric" th:text="${#numbers.formatInteger(model.eligibilityOverview.percentageGrant,1,'NONE')+'%'}" />
                <td class="numeric">&pound; <th:block th:text="${#numbers.formatInteger(model.eligibilityOverview.fundingSought,1,'COMMA')}" /></td>
                <td class="numeric">&pound; <th:block th:text="${#numbers.formatInteger(model.eligibilityOverview.otherPublicSectorFunding,1,'COMMA')}" /></td>
                <td class="numeric">&pound; <th:block th:text="${#numbers.formatInteger(model.eligibilityOverview.contributionToProject,1,'COMMA')}" /></td>

            </tr>
            </tbody>
        </table>
    </div>

    <form th:action="@{${#ifsUtil.uriWithQueryString(#httpServletRequest)}}" method="post" th:object="${form}"  enctype="multipart/form-data" novalidate="novalidate">
        <h2 class="heading-medium">Finances overview</h2>
        <p>These finances were initially submitted at the application stage. All saved changes to finances will be viewable by the applicants.</p>
        <p>All potential changes must be discussed with the lead applicant. You can do this by raising queries through IFS.</p>
        <section class="collapsible" th:each="subSection, subSectionstats : ${subSections.get(currentSectionId)}" th:if="${subSections !=null}">
            <h3>
                <th:block th:text="${subSection.getName()}" />
                <span th:attr="data-mirror='#section-total-'+${subSection.id}"></span>
                <span data-calculation-format="percentage"  data-calculation-operations="/,*" th:attr="data-mirror='#section-percentage-'+${subSection.id},data-calculation-fields='100, #total-cost, #section-total-'+${subSection.id}"></span>
            </h3>
            <div th:remove="tag" th:each="question : ${subsectionQuestions.get(subSection.id)}">
                <th:block th:each="formInput, status : ${subSectionQuestionFormInputs.get(question.id)}">
                    <th:block th:if="${formInput.type.displayableFinanceType}">
                        <!--/*
                        viewmode=approved; generates the inputs as text,
                        viewmode=readonly, generates readonly inputs,
                        viewmode=edit, generates the editable inputs + repeating row elements)
                        */-->
                        <th:block th:include="project/financecheck/fragments/finance :: ${formInput.type.nameLower} (viewmode='readonly')" th:with="formInputIndex=(${status.index})" />
                    </th:block>
                </th:block>
            </div>
        </section>
        <div class="grid-row total-cost">
            <div class="column-half">
                <label for="total-cost" class="heading-medium">Total project costs</label>
            </div>
            <div class="column-half alignright">
                <input type="text"
                       id="total-cost"
                       readonly="readonly"
                       class="heading-medium width-full alignright"
                       data-calculation-fields="[id*=section-total]"
                       data-calculation-operations="+"
                       th:value="'Â£ ' + ${#numbers.formatDecimal(organisationFinanceTotal, 0, 'COMMA', 0, 'POINT')}"/>
            </div>
        </div>
    </form>

    <form th:action="@{${#ifsUtil.uriWithQueryString(#httpServletRequest)}}" method="post" th:object="${eligibilityForm}">

        <th:block th:unless="${model.isReadOnly()}">
            <h2 class="heading-medium">Approve eligibility</h2>
            <p>After making any necessary changes, eligible costs should be approved.</p>
            <p>If changes are made, make sure the applicant has reviewed and understand all changes before you approve.</p>
            <div class="form-group">
                <label class="block-label selection-button-checkbox" for="project-eligible" data-target="add-rag-rating">
                    <input  id="project-eligible" type="checkbox" th:field="*{confirmEligibilityChecked}" data-disable-button-until-checked="#confirm-button" />These funding costs have been reviewed and are acceptable
                </label>
            </div>
            <div class="form-group" id="add-rag-rating">
                <label for="rag-rating" class="form-label">Please enter the RAG rating for this eligibility review</label>
                <select th:field="*{eligibilityRagStatus}" id="rag-rating" class="form-control" data-disable-button-until-checked="#confirm-button">
                    <option value="UNSET" th:selected="${eligibilityForm.eligibilityRagStatus == null}">--</option>
                    <option value="GREEN">Green</option>
                    <option value="AMBER">Amber</option>
                    <option value="RED">Red</option>
                </select>
            </div>
            <button type="button" data-js-modal="modal-confirm-eligibility" class="button" id="confirm-button">Approve eligible costs</button>
            <th:block  th:include="fragments/modals :: modal-confirm-eligibility" />
        </th:block>
        <hr/>
        <button th:if="${model.showSaveAndContinueButton}" class="button-secondary" name="save-and-continue">Save and return to finance checks</button>
        <a th:if="${model.showBackToFinanceCheckButton}" class="button button-secondary" th:href="@{/project/{projectId}/finance-check(projectId=${model.projectId})}">Return to finance checks</a>
    </form>

    <th:block th:include="fragments/layout :: main-content-end" />
</main>
<th:block th:include="fragments/layout :: footer" />
<th:block th:include="fragments/layout :: body-end" />
</body>
</html>
