<!DOCTYPE html>
<html class="no-js" lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <div th:include="fragments/layout :: head" th:with="pageTitle='Queries'" th:remove="tag" />
</head>

<body th:with="context='project-management'" class="query-form">
<div th:include="fragments/modals :: modal-overlay" th:remove="tag"/>

<div th:include="fragments/layout :: body-start" th:remove="tag" />
<div th:include="fragments/layout :: global-header" th:remove="tag" />

<main id="content">
    <div th:include="fragments/layout :: main-content-start" th:remove="tag" />
    <div th:include="fragments/layout :: header-sub" th:with="linkTitle='Finance checks',linkClass='link-back',linkUrl=@{/project/{projectId}/finance-check(projectId=${model.projectId})},currentCompetition=null"  />

    <div class="page-title">
        <div th:include="fragments/elements :: project-title (projectId=${model.projectId}, projectName=${model.projectName})" th:remove="tag" />
        <h1 class="heading-xlarge">
            <th:block th:text="${model.organisationName}" />
            <small th:if="${model.leadPartnerOrganisation}">(Lead Partner)</small>
        </h1>
    </div>

    <h2 class="heading-medium">Finance Contact</h2>
    <p>
        <th:block th:text="${model.financeContactName}">Finance Contact</th:block> <br />
        <a th:href="${'mailto:'+model.financeContactEmail}" th:text="${model.financeContactEmail}">example@example.com</a> <br />
        <th:block th:text="${model.financeContactPhoneNumber}">0</th:block>
    </p>

    <h2 class="heading-medium">Queries</h2>
    <p>
        If you have a query with the finances, use this section to raise your query with the finance contact.
        You must confirm any finance changes with the contact before you approve.
    </p>
    <th:block th:if="${!model.showNewQuery and !model.showNewPost}">
        <div class="grid-row extra-margin-top">
            <div class="column-half">
                <a id="post-new-query" th:href="@{query/new-query(query_section=${model.querySection})}" class="button button-large">Post a new query</a>
            </div>
        </div>
    </th:block>
    <th:block th:if="${model.showNewQuery and !model.showNewPost}">
        <form class="extra-margin" th:action="@{query/save-new-query(query_section=${model.querySection})}" th:object="${form}" method="post" enctype="multipart/form-data" novalidate="novalidate">
            <fieldset>
                <legend class="heading-medium">Post new query</legend>
                <div th:class="${#fields.hasErrors('title')}? 'form-group error':'form-group'">
                    <label for="title" class="form-label-bold">
                        <span class="heading-small no-margin">Title</span>
                        <span th:if="${#fields.hasErrors('title')}" th:remove="tag">
                              <span class="error-message" th:each="err : ${#fields.errors('title')}" th:text="${err}" />
                        </span>
                    </label>
                    <input name="title"
                           id="title"
                           th:class="${#fields.hasErrors('title') ? 'form-control field-error width-full' : 'form-control width-full'}"
                           required="required"
                           th:field="*{title}"
                           th:attr="maxlength=${model.maxTitleCharacters},data-maxlength-errormessage=#{validation.notesandqueries.thread.title.client.length.max(${model.maxTitleCharacters})},
                                    data-required-errormessage=#{validation.notesandqueries.thread.title.required}">
                </div>
                <div class="form-group">
                    <label for="section" class="form-label-bold">Section</label>
                    <select name="section" id="section" class="form-control">
                        <th:block th:each="section_type : ${T(org.innovateuk.ifs.notesandqueries.resource.thread.SectionTypeEnum).values()}">
                            <th:block th:if="*{section}">
                                <option th:value="${section_type.name()}"
                                        th:selected="${#strings.toLowerCase(section_type.name())} == *{section}"
                                        th:text="${#strings.capitalize(#strings.toLowerCase(section_type.name()))}">option</option>
                            </th:block>
                            <th:block th:unless="*{section}">
                                <th:block th:if="${model.querySection}">
                                    <option th:value="${section_type.name()}"
                                            th:selected="${#strings.toLowerCase(section_type.name()) == #strings.toLowerCase(model.querySection)}"
                                            th:text="${#strings.capitalize(#strings.toLowerCase(section_type.name()))}">option</option>
                                </th:block>
                                <th:block th:unless="${model.querySection}">
                                    <option th:value="${section_type.name()}"
                                            th:text="${#strings.capitalize(#strings.toLowerCase(section_type.name()))}">option</option>
                                </th:block>
                            </th:block>
                        </th:block>
                    </select>
                </div>
                <div th:class="${#fields.hasErrors('query')}? 'form-group error':'form-group'">
                    <label for="query" class="form-label-bold">
                        <span class="heading-small no-margin">Query</span>
                        <span th:if="${#fields.hasErrors('query')}" th:remove="tag">
                              <span class="error-message" th:each="err : ${#fields.errors('query')}" th:text="${err}" />
                        </span>
                    </label>
                    <div class="textarea-wrapped word-count">
                        <textarea data-editor="md"
                          required = "required"
                          th:field="*{query}"
                          id="query"
                          name="query"
                          th:attr="maxlength=${model.maxQueryCharacters}"
                          th:classappend="${#fields.hasErrors('query') ? 'form-control field-error' : 'form-control'}"></textarea>
                            <div class="textarea-footer" th:with="query=*{query}">
                                <div th:include="question-type/form-elements :: form-word-count (maxWords=${model.maxQueryWords}, currentWordsLeft=${#ifsUtil.wordsRemaining(model.maxQueryWords, content)})" th:remove="tag" />
                            </div>
                    </div>
                </div>
            </fieldset>
           <th:block th:if="${model.newAttachmentLinks.size() > 0}">
                <fieldset>
                    <legend class="heading-small">Supporting documentation</legend>
                    <th:block th:each="attachmentId : ${model.newAttachmentLinks.keySet()}">
                        <a th:href="@{query/attachment/{attachmentId}(query_section=${model.querySection},attachmentId=${attachmentId})}" th:text="${model.newAttachmentLinks.get(attachmentId)}">filename</a><br />
                    </th:block>
                </fieldset>
            </th:block>
            <fieldset>
                <div class="upload-section unstyled-view">
                    <legend class="heading-small no-margin">Upload supporting documentation</legend>
                    <span th:if="${#fields.hasErrors('attachment')}" th:remove="tag">
                        <span class="error-message" th:each="err : ${#fields.errors('attachment')}" th:text="${err}" />
                    </span>
                    <input type="file" id="attachment" class="inputfile" name="attachment">
                    <label for="attachment" class="button-secondary extra-margin">+ Upload</label>
                    <button name="uploadAttachment" class="button-secondary" type="submit" data-for-file-upload="attachment">Save</button>
                </div>
            </fieldset>
            <hr />
            <input type="hidden" id="action" value="postQuery">
            <div class="grid-row">
                <div class="column-half">
                    <button class="button button-large no-margin">Post Query</button>
                </div>
                <div class="column-half alignright">
                    <a th:href="@{query/cancel(query_section=${model.querySection})}">Cancel</a>
                </div>
            </div>
        </form>
    </th:block>

    <th:block th:if="${!model.showNewQuery}">
        <th:block th:each="query : ${model.getQueries()}">
            <hr />
            <h2 class="heading-medium non-margin-bottom" th:text="${query.title}">Query Thread Title</h2>
            <h3 class="heading-small no-margin" th:text="${query.sectionType}">Query Thread Section</h3>
            <th:block th:each="(post, iteration : ${query.viewModelPosts})">
                <th:block th:if="${iteration.index == 0}">
                    <p class="heading-small no-margin">
                        <th:block th:text="${post.username}">Created by user</th:block>
                        <small th:text="${#temporals.format(post.createdOn, 'dd/MM/yyyy HH:mm')}">Date and Time</small>
                    </p>
                    <p th:text="${post.postBody}"></p>
                    <legend th:if="${post.viewModelAttachments.size() > 0}" class="heading-small">Supporting documentation</legend>
                    <th:block th:each="attachment : ${post.viewModelAttachments}">
                        <a th:href="@{query/attachment/{attachmentId}(attachmentId=${attachment.localFileId})}" th:text="${attachment.filename}">file</a>
                    </th:block>
                </th:block>
                <th:block th:unless="${iteration.index == 0}">
                    <div class="panel">
                        <p>
                            <strong th:text="${post.username}">Created by user</strong>
                            <small th:text="${#temporals.format(post.createdOn, 'dd/MM/yyyy HH:mm')}">Date and Time</small>
                        </p>
                        <p th:text="${post.postBody}"></p>
                        <h3 th:if="${post.viewModelAttachments.size() > 0}" class="heading-small">Supporting documentation</h3>
                        <th:block th:each="attachment : ${post.viewModelAttachments}">
                            <a th:href="@{query/attachment/{attachmentId}(attachmentId=${attachment.localFileId})}" th:text="${attachment.filename}">file</a>
                        </th:block>
                    </div>
                </th:block>
            </th:block>
            <hr />
            <th:block th:if="${!query.awaitingResponse}">
                <th:block th:if="${!model.showNewPost and !model.showNewQuery}">
                    <div class="grid-row extra-margin-top">
                        <div class="column-half">
                            <a id="post-new-response" th:href="@{query/{queryId}/new-response(query_section=${model.querySection},queryId=${query.id})}" class="button button-secondary">Respond</a><br />
                        </div>
                    </div>
                </th:block>
                <th:block th:if="${model.showNewPost and !model.showNewQuery and query.id == model.newPostQueryId}">
                    <form class="extra-margin" th:action="@{query/{queryId}/save-new-response(query_section=${model.querySection}, queryId=${query.id})}" th:object="${form}" method="post" enctype="multipart/form-data" novalidate="novalidate">
                        <fieldset>
                            <legend class="heading-medium">Post response</legend>
                            <div th:class="${#fields.hasErrors('query')}? 'form-group error':'form-group'">
                                <label for="query" class="form-label-bold">
                                    <span class="heading-small no-margin">Query</span>
                                    <span th:if="${#fields.hasErrors('query')}" th:remove="tag">
                                      <span class="error-message" th:each="err : ${#fields.errors('query')}" th:text="${err}" />
                                </span>
                                </label>
                                <div class="textarea-wrapped word-count">
                                <textarea data-editor="md"
                                          required = "required"
                                          th:field="*{query}"
                                          id="query"
                                          name="query"
                                          th:attr="maxlength=${model.maxQueryCharacters}"
                                          th:classappend="${#fields.hasErrors('query') ? 'form-control field-error' : 'form-control'}"></textarea>
                                    <div class="textarea-footer" th:with="query=*{query}">
                                        <div th:include="question-type/form-elements :: form-word-count (maxWords=${model.maxQueryWords}, currentWordsLeft=${#ifsUtil.wordsRemaining(model.maxQueryWords, content)})" th:remove="tag" />
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                        <th:block th:if="${model.newAttachmentLinks.size() > 0}">
                            <fieldset>
                                <legend class="heading-small">Supporting documentation</legend>
                                <th:block th:each="attachmentId : ${model.newAttachmentLinks.keySet()}">
                                    <a th:href="@{query/attachment/{attachmentId}(query_section=${model.querySection},attachmentId=${attachmentId})}" th:text="${model.newAttachmentLinks.get(attachmentId)}">filename</a><br />
                                </th:block>
                            </fieldset>
                        </th:block>
                        <fieldset>
                            <div class="upload-section unstyled-view">
                                <legend class="heading-small no-margin">Upload supporting documentation</legend>
                                <span th:if="${#fields.hasErrors('attachment')}" th:remove="tag">
                                <span class="error-message" th:each="err : ${#fields.errors('attachment')}" th:text="${err}" />
                            </span>
                                <input type="file" id="attachment" class="inputfile" name="attachment">
                                <label for="attachment" class="button-secondary extra-margin">+ Upload</label>
                                <button name="uploadAttachment" class="button-secondary" type="submit" data-for-file-upload="attachment">Save</button>
                            </div>
                        </fieldset>
                        <hr />
                        <input type="hidden" id="action" value="postResponse">
                        <div class="grid-row">
                            <div class="column-half">
                                <button class="button button-large no-margin">Post response</button>
                            </div>
                            <div class="column-half alignright">
                                <a th:href="@{query/cancel(query_section=${model.querySection})}">Cancel</a>
                            </div>
                        </div>
                    </form>
                </th:block>
            </th:block>
        </th:block>
    </th:block>


    <th:block th:include="fragments/layout :: main-content-end" />
</main>
<th:block th:include="fragments/layout :: footer" />
<th:block th:include="fragments/layout :: body-end" />
</body>
</html>
