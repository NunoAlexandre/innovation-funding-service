var ifs_autoSave=function(){"use strict";var e;return{settings:{inputs:'.form-serialize-js input:not([type="button"],[readonly="readonly"])',textareas:'.form-serialize-js textarea:not([readonly="readonly"])',typeTimeout:500,minimumUpdateTime:1e3},init:function(){e=this.settings;var t=e.inputs+","+e.textareas;jQuery("body").on("change",t,function(e){ifs_autoSave.fieldChanged(e.target)}),jQuery("body").on("keyup",t,function(t){clearTimeout(window.ifs_autoSave_timer),window.ifs_autoSave_timer=setTimeout(function(){ifs_autoSave.fieldChanged(t.target)},e.typeTimeout)})},fieldChanged:function(e){var t=jQuery(e),i=t.attr("id"),n={value:t.val(),formInputId:i,fieldName:t.attr("name"),applicationId:jQuery(".form-serialize-js #application_id").val()},a=jQuery(".form-serialize-js").serialize(),r=t.closest(".form-group"),o=r.find(".validation-messages").first(),s=r.find(".textarea-save-info"),u=(new Date).getTime();0===s.length&&(r.find(".textarea-footer").append('<span class="textarea-save-info" />'),s=r.find(".textarea-save-info")),jQuery.ajax({type:"POST",url:"/application-form/saveFormElement",data:n,dataType:"json",beforeSend:function(){s.html("Saving...")}}).done(function(e){var i=(new Date).getTime(),n=ifs_autoSave.settings.minimumUpdateTime-(i-u);jQuery(".form-serialize-js").data("serializedFormState",a),t.removeClass("error"),r.removeClass("error"),"true"==e.success?setTimeout(function(){ifs_autoSave.removeValidationError(r),s.html("Saved!")},n):setTimeout(function(){s.html("Invalid input, but saved anyway."),ifs_autoSave.removeValidationError(r),jQuery.each(e.validation_errors,function(e,t){o.append('<span class="error-message">'+t+"</span>")}),r.addClass("error")},n)}).fail(function(e){var i=(new Date).getTime(),n=ifs_autoSave.settings.minimumUpdateTime-(i-u);setTimeout(function(){ifs_autoSave.removeValidationError(r);var i=e.responseJSON.errorMessage;if(r.length)if(r.addClass("error"),s.length)s.html(i);else{var n=r.find("label").first();n.length&&o.append('<span class="error-message">'+i+"</span>")}else t.addClass("error")},n)})},removeValidationError:function(e){e.removeClass("error"),e.find(".error-message").remove()}}}(),ifs_closeCss=function(){"use strict";var e;return{settings:{isOpenCssClass:"is-open",timeOpen:3e3},init:function(){e=this.settings,ifs_closeCss.removeCssClass(e.isOpenCssClass,e.timeOpen)},removeCssClass:function(e,t){var i=jQuery("."+e);i.length&&setTimeout(function(){i.removeClass(e)},t)}}}(),ifs_collapsible=function(){"use strict";var e;return{settings:{collapsibleEl:".collapsible > h2, .assign-container .assign-button"},init:function(){e=this.settings,ifs_collapsible.collapsibleWithinScope(jQuery(document))},collapsibleWithinScope:function(t){var i=t.find("[data-collapsible-id]"),n=0;i.each(function(e,t){var i=t.attr("data-collapsible-id");n=Math.max(n,parseInt(i))}),t.find(e.collapsibleEl).each(function(e,t){var i=jQuery(t);ifs_collapsible.addCollapsibleBehaviourToElement(i,e,n+1)})},addCollapsibleBehaviourToElement:function(e,t,i){var n="collapsible-"+(t+i),a=e.hasClass("open"),r=!1;e.closest(".collapsible").hasClass("js-close-others")&&(r=!0),e.nextUntil("h2").wrapAll('<div id="'+n+'" aria-hidden="'+!a+'">');var o=e.next();e.wrapInner('<button aria-expanded="'+a+'" aria-controls="'+n+'" type="button">');var s=e.children("button");s.off("click").on("click",function(){var e="false"===jQuery(this).attr("aria-expanded")?!0:!1;if(r){var t=jQuery(this).closest(".collapsible");t.find("[aria-expanded]").attr("aria-expanded","false"),t.find("[aria-hidden]").attr("aria-hidden","true")}jQuery(this).attr("aria-expanded",e),o.attr("aria-hidden",!e)})}}}(),ifs_conditionalForms=function(){"use strict";return{init:function(){jQuery("label[data-target]").each(function(){var e=jQuery(this),t=e.attr("data-target"),i=jQuery("#"+t),n=e.find('input[type="radio"],input[type="checkbox"]');if(n&&t&&i){var a=n.attr("name");n.attr("aria-controls",t),ifs_conditionalForms.toggleVisibility(n,i),jQuery('input[name="'+a+'"]').on("click",function(){ifs_conditionalForms.toggleVisibility(n,i)})}})},toggleVisibility:function(e,t){e.is(":checked")?(e.attr("aria-expanded","true"),t.attr("aria-hidden","false").removeClass("js-hidden")):(e.attr("aria-expanded","false"),t.attr("aria-hidden","true"))}}}(),ifs_editor=function(){"use strict";var e,t;return{settings:{textareas:".textarea-wrapped textarea",htmlOptions:{format:!1,allowedTags:["p","em","strong","ol","ul","li","br","b","div"]}},init:function(){e=this.settings,t=new showdown.Converter;var i=jQuery(e.textareas);jQuery.each(i,function(){ifs_editor.prepareEditor(this)}),ifs_editor.initEditors(),ifs_editor.bindEditors()},prepareEditor:function(e){var t=jQuery(e);t.attr("readonly")?t.before('<div class="readonly"></div>'):t.before('<div class="editor"></div>'),t.attr("aria-hidden","true"),ifs_editor.processMarkdownToHtml(t,t.prev())},initEditors:function(){jQuery(".editor").hallo({plugins:{halloformat:{},hallolists:{},hallocleanhtml:e.htmlOptions},toolbar:"halloToolbarFixed"})},bindEditors:function(){jQuery(".editor").bind("hallomodified",function(e,t){var i=jQuery(this).next();ifs_editor.processHtmlToMarkdown(t.content,i),jQuery(i).trigger("keyup")})},processMarkdownToHtml:function(e,t){var i=e.val();if(ifs_editor.htmlToMarkdown(jQuery(t).html())!=i){var n=ifs_editor.markdownToHtml(i);jQuery(t).html(n)}},processHtmlToMarkdown:function(e,t){var i=ifs_editor.htmlToMarkdown(e);jQuery(t).get(0).value!=i&&(jQuery(t).get(0).value=i)},htmlToMarkdown:function(t){var i=jQuery.trim(t.replace(/(\r\n|\n|\r)/gm,""));return i=jQuery.htmlClean(i,e.htmlOptions),md(i)},markdownToHtml:function(e){var i;return i=0===e.length?"<p>&nbsp;</p>":t.makeHtml(e)}}}(),ifs_financeRows=function(){"use strict";return{init:function(){jQuery(document).on("click","[data-finance-subsection-table-container] .add-another-row",ifs_financeRows.addCostsRowHandler),jQuery(document).on("click","[data-finance-subsection-table-container] .delete-row",ifs_financeRows.removeCostsRowHandler)},generateFragmentUrl:function(e){var t=e.attr("href"),i=t.split("?"),n=i[0],a=2==i.length?"&"+i[1]:"",r=e.parents("[data-question-id]"),o=r.attr("data-question-id"),s=n+"/"+o+"?singleFragment=true"+a;return s},addCostsRowHandler:function(e){var t=jQuery(this),i=ifs_financeRows.generateFragmentUrl(t);return jQuery.get(i,function(e){var i=jQuery("<div>"+e+"</div>"),n=t.parents("[data-finance-subsection-table-container]"),a=n.attr("data-finance-subsection-table-container"),r=i.find("[data-finance-subsection-table-container="+a+"]");n.replaceWith(r),ifs_autoSave.init()}),e.preventDefault(),!1},removeCostsRowHandler:function(e){var t=jQuery(this),i=ifs_financeRows.generateFragmentUrl(t);return jQuery.get(i,function(){var e=t.attr("data-cost-row"),i=jQuery("[data-cost-row="+e+"]");i.find("[data-calculation-fields],[data-calculation-input]").val(0).attr("data-calculation-rawvalue",0).trigger("change"),i.remove()}),e.preventDefault(),!1}}}(),ifs_finance=function(){"use strict";return{MathOperation:{"+":function(e,t){return e+t},"-":function(e,t){return e-t},"*":function(e,t){return e*t},"/":function(e,t){return 0===t?0:e/t}},init:function(){ifs_finance.bindCalculationActionToFields(),ifs_finance.sectionInfoInHeader(),ifs_finance.mirrorInputs(),jQuery("body").append(jQuery('<div class="js-hidden"><input id="hundred-field" value="100" /></div>'))},bindCalculationActionToFields:function(){var e=function(e,t){var i=e.attr("data-calculation-fields").split(","),n=i.map(function(e){return jQuery(e)}),a=n.reduce(function(e,t){return jQuery.merge(e,t)}),r=function(e){return e instanceof jQuery?e.attr("id"):jQuery(e).attr("id")};-1!==a.toArray().map(r).indexOf(r(t))&&ifs_finance.doMath(e,a)};jQuery("body").on("change","input",function(){var t=jQuery(this),i=jQuery("[data-calculation-fields]");i.each(function(i,n){var a=jQuery(n);e(a,t)})})},doMath:function(e,t){for(var i=e.attr("data-calculation-operations").split(","),n=[],a=0;a<t.length;a++){var r=jQuery(t[a]),o=r.attr("data-calculation-rawvalue");if("undefined"!=typeof o)n.push(parseFloat(o));else{var s=r.val();if("undefined"!=typeof s&&s.length>0){var u=0===s.indexOf("£ ")?s.substring(2):s;n.push(parseFloat(u))}else n.push(parseFloat(0))}}var l;if(l=1===n.length?n[0]:ifs_finance.MathOperation[i[0]](n[0],n[1]),1==i.length&&n.length>2)for(a=2;a<n.length;a++)l=ifs_finance.MathOperation[i[0]](l,n[a]);else if(i.length>1&&n.length>2)for(a=1;a<i.length;a++)l=ifs_finance.MathOperation[i[a]](l,n[a+1]);e.attr("data-calculation-rawvalue",l);var d=ifs_finance.formatCurrency(Math.round(l));e.is("span")?e.text(d):e.val(d),e.trigger("change")},formatCurrency:function(e){return e=parseFloat(e,10),e=e.toFixed(),e=e.replace(/(\d)(?=(\d{3})+\b)/g,"$1,"),"£ "+e.toString()},mirrorInputs:function(){jQuery("body").on("change","[data-binding-input]",function(){var e=jQuery(this),t=e.attr("data-binding-input"),i=jQuery('[data-binding-output="'+t+'"]');i.each(function(){var t=jQuery(this);t.is("span")?t.text(e.val()):t.val(e.val())})})},sectionInfoInHeader:function(){jQuery(".place-in-header").each(function(){var e=jQuery(this),t=e.attr("data-subsection-id"),i=jQuery("[data-subsection-header="+t+"]");e.detach(),i.append(e),e.show()})}}}(),ifs_modal=function(){"use strict";var e;return{settings:{element:"[data-js-modal]"},init:function(){e=this.settings,jQuery(e.element).length&&(ifs_modal.initModals(),ifs_modal.modalCloseLink())},initModals:function(){jQuery("body").on("click",e.element,function(e){e.preventDefault();var t=jQuery(this).attr("data-js-modal");t=jQuery("."+t),t.length&&(e.preventDefault(),ifs_modal.disableTabPage(),t.add(".modal-overlay").attr("aria-hidden","false"),setTimeout(function(){var e=t.outerHeight();t.css({"margin-top":"-"+e/2+"px"})},50))})},disableTabPage:function(){jQuery(":tabbable").each(function(){var e=jQuery(this);if(0===e.closest('[role="dialog"]').length){var t=0;e.prop("tabindex")&&(t=e.prop("tabindex")),e.prop("tabindex","-1").attr("data-original-tabindex",t)}})},enableTabPage:function(){jQuery("[data-original-tabindex]").each(function(){var e=jQuery(this),t=e.attr("data-original-tabindex");e.prop("tabindex",t).removeAttr("data-original-tabindex")})},modalCloseLink:function(){jQuery("body").on("click",".js-close",function(){ifs_modal.enableTabPage(),jQuery('[role="dialog"],.modal-overlay').attr("aria-hidden","true")})}}}(),ifs_pieChart=function(){"use strict";var e;return{settings:{pieElement:".pie"},init:function(){e=this.settings,Modernizr.svg&&Modernizr.inlinesvg&&jQuery(e.pieElement).each(function(){ifs_pieChart.pieSVG(this)})},pieSVG:function(e){var t=parseFloat(e.textContent),i="http://www.w3.org/2000/svg",n=document.createElementNS(i,"svg"),a=document.createElementNS(i,"circle"),r=document.createElementNS(i,"title");a.setAttribute("r",16),a.setAttribute("cx",16),a.setAttribute("cy",16),a.setAttribute("stroke-dasharray",t+" 100"),n.setAttribute("viewBox","0 0 32 32"),r.textContent=e.textContent,e.textContent="",n.appendChild(r),n.appendChild(a),e.appendChild(n)}}}(),ifs_unsavedChanges=function(){"use strict";var e;return{settings:{formelement:jQuery(".form-serialize-js")},init:function(){e=this.settings,ifs_unsavedChanges.initUnsavedChangesWarning()},initUnsavedChangesWarning:function(){e.formelement.data("serializedFormState",jQuery(".form-serialize-js").serialize());var t=!1;e.formelement.on("submit",function(){t=!0}),jQuery(window).bind("beforeunload",function(e){return t===!1&&jQuery(".form-serialize-js").serialize()!=jQuery(".form-serialize-js").data("serializedFormState")?"Are you sure you want to leave this page? There are some unsaved changes...":void(e=null)})}}}(),ifs_wordCount=function(){"use strict";var e;return{settings:{wordcountEl:".word-count textarea",typeTimeout:500},init:function(){e=this.settings,jQuery("body").on("change",e.wordcountEl,function(e){ifs_wordCount.updateWordCount(e.target)}),jQuery("body").on("keyup",e.wordcountEl,function(t){clearTimeout(window.ifs_wordcount_timer),window.ifs_wordcount_timer=setTimeout(function(){ifs_wordCount.updateWordCount(t.target)},e.typeTimeout)})},updateWordCount:function(e){var t=jQuery(e),i=t.val();i=i.replace(/(\r\n|\n|\r)/gm," "),i=i.replace(/([[0-9]+\.\ |\*\ |\*\*|_)/gm,"");for(var n=jQuery.trim(i).split(" "),a=0,r=0;r<n.length;r++)n[r].length>0&&a++;var o=t.attr("data-max_words")-a,s=t.parents(".word-count").find(".count-down");s.html(o),0>o?s.removeClass("positive").addClass("negative"):s.removeClass("negative").addClass("positive")}}}(),ifs_application_page=function(){"use strict";return{init:function(){jQuery(document).on("click",'form.application-overview [name="assign_question"]',ifs_application_page.handleAssignQuestionFragmentReload)},handleAssignQuestionFragmentReload:function(e){var t=jQuery(this),i=t.closest("form.application-overview"),n=t.closest("li.section[data-question-id]"),a=n.attr("data-section-id"),r=function(e){var t=jQuery("<div>"+e+"</div>"),i=n.attr("data-question-id"),a=t.find("li.section[data-question-id="+i+"]");n.replaceWith(a),ifs_collapsible.collapsibleWithinScope(a)};return jQuery.ajax({type:"POST",url:"?singleFragment=true&sectionId="+a,data:i.serialize()+"&"+t.attr("name")+"="+t.attr("value"),success:function(e){r(e)}}),e.preventDefault(),!1}}}(),ifs_assesment_feedback_page=function(){"use strict";return{init:function(){jQuery("body").on("change",'[id ^= "assessor-question-feedback-text-"],[data-feedback-value]',ifs_assesment_feedback_page.handleAssessorFeedbackUpdate),jQuery("body").on("keyup",'[id ^= "assessor-question-feedback-"]',ifs_assesment_feedback_page.registerKeyupCallback(ifs_assesment_feedback_page.handleAssessorFeedbackFieldChangeOnField,500))},registerKeyupCallback:function(e,t){return function(i){var n=jQuery(this),a=n.data("keyupListener");"undefined"!=typeof a&&window.clearTimeout(a),n.data("keyupListener",window.setTimeout(function(){e(n,i),n.data("keyupListener",null)},t))}},handleAssessorFeedbackFieldChangeOnField:function(e){var t=e.closest("form").attr("action"),i=e.closest("[data-response-id]"),n=i.attr("data-response-id"),a=i.find('[id ^= "assessor-question-feedback-text-"]').val(),r=i.find("[data-feedback-value]").val(),o=e.closest(".form-group"),s=o.find(".textarea-save-info"),u=(new Date).getTime();0===s.length&&(o.find(".textarea-footer").append('<span class="textarea-save-info" />'),s=o.find(".textarea-save-info")),jQuery.ajax({type:"PUT",url:t+"/response/"+n+"?feedbackText="+a+"&feedbackValue="+r,beforeSend:function(){s.html("Saving...")}}).done(function(e){var t=(new Date).getTime();"ok"==e.message?1500>t-u?setTimeout(function(){s.html("Saved!")},1500):s.html("Saved!"):s.html(e.message).css({color:"red"})})},handleAssessorFeedbackUpdate:function(){var e=jQuery(this);return ifs_assesment_feedback_page.handleAssessorFeedbackFieldChangeOnField(e)}}}(),ifs_assesment_submit_review_page=function(){"use strict";return{init:function(){ifs_assesment_submit_review_page.suitableForFundingChange(),ifs_assesment_submit_review_page.beforeSubmitCheck()},suitableForFundingChange:function(){jQuery("#suitable-for-funding").change(function(){var e=jQuery("#suitable-for-funding option:selected").val(),t=jQuery("#recommendation-feedback-group");e=t.show(),jQuery("#not-suitable-feedback").prop("required","no"==e)}).trigger("change")},beforeSubmitCheck:function(){jQuery("#submission_questions").submit(function(e){var t=jQuery("#suitable-for-funding option:selected").val(),i=""===jQuery("#not-suitable-feedback").val().trim();return"no"==t&&i?(e.preventDefault(),jQuery("#feedback-empty-error").text("Please justify your decision...").show(),!1):void jQuery("#feedback-empty-error").hide()})}}}(),IFS={common:{init:function(){ifs_collapsible.init(),ifs_wordCount.init(),ifs_editor.init(),ifs_conditionalForms.init()},finalize:function(){ifs_pieChart.init(),ifs_modal.init(),ifs_closeCss.init()}},"app-form":{init:function(){ifs_unsavedChanges.init(),ifs_autoSave.init(),ifs_finance.init(),ifs_financeRows.init()}},"app-details":{init:function(){ifs_application_page.init()}},"assessment-details":{init:function(){ifs_assesment_feedback_page.init()}},"assessment-submit-review":{init:function(){ifs_assesment_submit_review_page.init()}}},UTIL=function(){"use strict";return{fire:function(e,t,i){var n=IFS;t=void 0===t?"init":t,""!==e&&n[e]&&"function"==typeof n[e][t]&&n[e][t](i)},loadEvents:function(){var e=document.body.id;UTIL.fire("common"),jQuery.each(document.body.className.split(/\s+/),function(t,i){UTIL.fire(i),UTIL.fire(i,e)}),UTIL.fire("common","finalize")}}}();jQuery(document).ready(function(){UTIL.loadEvents()});