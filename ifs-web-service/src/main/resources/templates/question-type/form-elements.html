<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">

<!-- =========================== Form label =========================== -->
<div th:fragment="form-label (name,id,bold)">
    <label th:class="${bold}? 'form-label form-label-bold' : 'form-label'"
           th:if="${name}"
           th:for="${id}"
           th:text="${name}"
            />
</div>
<!-- =========================== Form label hidden =========================== -->
<div th:fragment="form-label-hidden (name,id)">
    <label class="form-label visuallyhidden"
    th:if="${name}"
    th:for="${id}"
    th:text="${name}"
    />
</div>
<!-- =========================== Form validation messages =========================== -->
<div th:fragment="form-validation-messages (id)">
    <div class="validation-messages" th:with="validationId='formInput['+${id}+']'" >
        <span class="error-message" th:if="${#fields.hasErrors(validationId)}" th:errors="*{__${validationId}__}"></span>
    </div>
</div>
<!-- ===========================Form hint =========================== -->
<div th:fragment="form-hint (hint)">
    <div class="form-hint"
         th:if="${hint}"
         th:text="${hint}"
            />
</div>
<!-- ========================= Form Guidance =========================== -->

<div th:fragment="form-guidance">
    <details th:if="${question.getGuidanceQuestion()}">
        <summary>
            <span class="summary" th:text="${question.getGuidanceQuestion()}"/>
        </summary>
        <div class="panel-indent" th:utext="${question.getGuidanceAnswer()}">
        </div>
    </details>
</div>
<!-- ========================= input field type text =========================== -->

<div th:fragment="form-textinput (id, response)">
    <input class="form-control"
           th:readonly="${readonly}"
           type="text"
           th:id="${id}"
           th:name="${name != null} ? ${name} : 'formInput['+${id}+']'"
           th:field="*{formInput[__${id}__]}"
           th:attrappend="placeholder=${placeholder != null}?@{${placeholder}}"
            />
</div>
<!-- ========================= input field type text =========================== -->

<div th:fragment="form-textinput-full-width (id, field)">
    <input class="form-control width-full"
           th:readonly="${readonly}"
           type="text"
           th:id="${id}"
           th:field="*{__${field}__}"
           th:attrappend="placeholder=${placeholder != null}?@{${placeholder}}"
            />
</div>
<!-- ========================= input field type number =========================== -->

<div th:fragment="form-number (id, response)">
    <input class="form-control"
           th:readonly="${readonly}"
           type="number"
           th:id="${id}"
           th:name="${name != null} ? ${name} : 'formInput['+${id}+']'"
           th:value="${response}"
           th:attrappend="placeholder=${placeholder != null}?@{${placeholder}}"

            />
</div>

<!-- ========================= input field type number =========================== -->

<div th:fragment="form-number-extra-small (id, field)">
    <input class="form-control width-extra-small"
           th:readonly="${readonly}"
           type="number"
           th:id="${id}"
           th:field="*{__${field}__}"
           th:attrappend="placeholder=${placeholder != null}?@{${placeholder}}"
           th:min="${min}"
           th:max="${max}"
            />
</div>

<!-- ========================= date field =========================== -->

<div th:fragment="form-dateinput (id, field)">
    <div class="date-group">
        <div class="day">
            <input type="hidden" th:name="${field}" value="to be ignored" />

            <div th:include="question-type/form-elements :: form-label (name='Day',id=${id}+'_day',bold=false)"
                 th:remove="tag"/>
            <div th:include="question-type/form-elements :: form-number-extra-small (id=${id}+'_day', field=${field}+'.dayOfMonth',placeholder='DD')"
                 th:remove="tag"/>
        </div>
        <div class="month">
            <div th:include="question-type/form-elements :: form-label (name='Month',id=${id}+'_month',bold=false)"
                 th:remove="tag"/>
            <div th:include="question-type/form-elements :: form-number-extra-small (id=${id}+'_month', field=${field}+'.monthValue',placeholder='MM')"
                 th:remove="tag"/>
        </div>
        <div class="year">
            <div th:include="question-type/form-elements :: form-label (name='Year',id=${id}+'_year',bold=false)"
                 th:remove="tag"/>
            <div th:include="question-type/form-elements :: form-number-extra-small (id=${id}+'_year', field=${field}+'.year',placeholder='YYYY')"
                 th:remove="tag"/>
        </div>
    </div>
</div>


<!-- ========================= Duration in months =========================== -->

<div th:fragment="form-duration (id, field)">
  <div class="form-group">
    <div th:include="question-type/form-elements :: form-label (name='Duration months',id=${id},bold=false)" th:remove="tag"/>
      <div th:include="question-type/form-elements :: form-validation-messages (id=${id})" th:remove="tag" />
    <div th:include="question-type/form-elements :: form-number-extra-small (id=${id}, field=${field})" th:remove="tag"/>
  </div>
</div>

<div th:fragment="form-percentage (id, title, field)">
    <div th:include="question-type/form-elements :: form-label (name=${title},id=${id},bold=false)" th:remove="tag"/>
    <div th:include="question-type/form-elements :: form-number-extra-small (id=${id}, field=${field}, min=0, max=100)" th:remove="tag"/>
</div>
<!-- ========================= textarea  =========================== -->

<div th:fragment="form-textarea (id, name, value,readonly)">
		<textarea
                th:id="${id}"
                th:name="${name != null} ? ${name} : 'formInput['+${id}+']'"
                th:field="*{formInput[__${id}__]}"
                th:readonly="${readonly}"
                th:attrappend="data-max_words=${wordCount != null}?@{${wordCount}}"
                th:attr="rows=${textareaRows != null ? textareaRows : ''}, cols=${textareaCols != null ? textareaCols : ''}"
                >
		</textarea>
</div>
<div th:fragment="form-finance-textarea (type, id, name, value)">
		<textarea  class="form-control"
                th:id="${'cost-'+ type + '-'+id+'-'+name}"
                th:name="${type +'-'+name+'-' + id}"
                th:text="${value}"
                rows="4"
                >
		</textarea>
</div>

<div th:fragment="form-textarea-wordcount (id, name, value, readonly, maxWords)">
    <div class="textarea-wrapped word-count">
        <div th:include="question-type/form-elements :: form-textarea (
		 					id=${id},
		 					value=${value},
		 					wordCount=${maxWords},
		 					readonly=false,
		 					name=${name}
		 					)" th:remove="tag">
        </div>

        <div class="textarea-footer">
            <div th:include="question-type/form-elements :: form-word-count (maxWords=${maxWords}, currentWordsLeft=${response?.getWordCountLeft()})" th:remove="tag"/>
        </div>
    </div>
</div>
<!-- ========================= textarea wrapped within all extra's =========================== -->

<div th:fragment="form-textarea-wrapped">
    <div th:class="'textarea-wrapped ' +
                   (${readonly} ? '' : (
                            (${question.isMarkAsCompletedEnabled() and markedAsComplete?.contains(question.id)} ? 'marked-as-complete' :
                                (${!(question.isMarkAsCompletedEnabled() and markedAsComplete.contains(question.id)) and ((currentUser.getId() == questionAssignee?.getAssignee()?.getUser()?.getId()) or ((questionAssignee?.getAssignee() == null) and (leadApplicant?.getUser()?.getId() == currentUser.getId())))} ? 'assigned-to-me ' : '')
                            )
                       )
                       + ' ' +
                       (${formInput.getWordCount() == 0} ? '' : 'word-count')
                   )
                  "

         th:with="currentUser=${#authentication.getDetails()},validationId='formInput['+${question.getId()}+']'">

         <div th:unless="${readonly}" class="textarea-header" th:id="${validationId}">
           <img th:if="${question.isMarkAsCompletedEnabled() and markedAsComplete?.contains(question.id)}"
                 src="/images/field/field-done.png"
                 alt="This field is marked as complete"
                 title="This field is marked as complete"
                 class="marked-as-complete" />

            <div th:if="${question.isMarkAsCompletedEnabled() and markedAsComplete?.contains(question.id)}" th:remove="tag">
                  <div class="assignee">This question is <strong>marked as complete</strong></div>
            </div>

            <img th:if="${!(question.isMarkAsCompletedEnabled() and markedAsComplete.contains(question.id)) and ((currentUser.getId() == questionAssignee?.getAssignee()?.getUser()?.getId()) or ((questionAssignee?.getAssignee() == null) and (leadApplicant?.getUser()?.getId() == currentUser.getId())))}"
                 src="/images/field/field-assigned.png"
                 alt="This field is assigned to you"
                 title="This field is assigned to you"
                 class="assigned-to-me" />

            <div th:unless="${question.isMarkAsCompletedEnabled() and markedAsComplete?.contains(question.id)}"
                 th:include="question-type/form-elements :: current-assignee" th:remove="tag"/>
        </div>

        <div th:include="question-type/form-elements :: form-textarea (
		 					id=${formInput.getId()},
		 					value=((${response} == null ) ? '' : ${response?.getValue()} ),
		 					wordCount=${formInput.getWordCount()},
		 					readonly=${readonly} or ${question.isMarkAsCompletedEnabled() and
		 					    markedAsComplete?.contains(question.id)} or
		 					    ${(currentUser.getId() != questionAssignee?.getAssignee()?.getUser()?.getId() and  questionAssignee?.getAssignee()!=null) or
		 					    (questionAssignee?.getAssignee()==null and !userIsLeadApplicant)},
                                name='formInput['+${formInput.getId()}+']'
                                )" th:remove="tag">
        </div>

        <div class="textarea-footer">
          <p>
            <div th:include="question-type/form-elements :: last-update-info" th:remove="tag"/>
            <div th:include="question-type/form-elements :: form-word-count (maxWords=${formInput.getWordCount()}, currentWordsLeft=${response?.getWordCountLeft()})" th:remove="tag"/>
          </p>
            <div th:unless="${readonly} or ${question.isMarkAsCompletedEnabled() and markedAsComplete?.contains(question.id)} or ${!userIsLeadApplicant}"
                 th:include="question-type/form-elements :: assign-buttons" th:remove="tag"/>

            <!-- if  readonly we show the edit form button-->
            <div th:if="${readonly}" th:include="question-type/form-elements :: form-edit-question-button"
                 th:remove="tag"/>
            <!--  we show mark as complete buttons and the question should be assigned to you or-->
            <div th:unless="(${currentUser.getId() != questionAssignee?.getAssignee()?.getUser()?.getId()} and ${!userIsLeadApplicant})" th:include="question-type/form-elements :: form-mark-as-complete-buttons"
                 th:remove="tag"/>

        </div>


    </div>
</div>
<!-- ========================= Current Assignee =========================== -->
<div th:fragment="current-assignee">
    <div th:class="(${currentUser.getId() == questionAssignee?.getAssignee()?.getUser()?.getId()} ? 'assignee  assigned-to-me ' : 'assignee')" th:if="${questionAssignee?.getAssignee()}">
        <span>This question is assigned to</span>
        <span th:text="${currentUser.getId() == questionAssignee?.getAssignee()?.getUser()?.getId() ? 'you' : questionAssignee?.getAssignee()?.getUser()?.getName()}"/>
    </div>
</div>
<!-- ========================= Assign / reassign buttons =========================== -->
<div th:fragment="assign-buttons">
    <div class="assign-container collapsible js-close-others" th:if="${question.isAssignEnabled()}">

        <div class="assign-button">
              <div th:include="question-type/form-elements :: assigned-to" th:remove="tag"/>
        </div>
        <div class="assign-team">
            <h3>Reassign question</h3>
            <ul class="list-bullet">
                <li th:each="assignableUser : ${assignableUsers}">
                    <button type="submit" name="assign_question"
                            th:value="${question.getId()}+'_'+${assignableUser.getId()}"
                            th:unless="${(questionAssignee?.getAssignee()?.getId() == assignableUser.getId()) or ((questionAssignee?.getAssignee() == null) and (leadApplicant?.getId() == assignableUser.getId()))}"
                            th:text="${assignableUser.getUser()?.getName()}"
                            th:attrappend="formaction='&#35;question-'+${question.getId()}"
                            class="buttonlink"/>
                    <div th:if="${(questionAssignee?.getAssignee()?.getId() == assignableUser.getId()) or ((questionAssignee?.getAssignee() == null) and (leadApplicant?.getId() == assignableUser.getId()))}"
                         th:text="${assignableUser.getUser()?.getName()}"/>
                </li>
            </ul>
        </div>
    </div>
</div>
<!-- ========================= Assigned to =========================== -->
<div th:fragment="assigned-to">
        <div th:remove="tag" th:if="${questionAssignee?.getAssignee() != null} ">
            Assigned to: <strong th:text="${name}" th:with="name=${(questionAssignee?.getAssignee()?.getUser()?.getId() == currentUser.getId()) ? 'You' : questionAssignee?.getAssignee()?.getUser()?.getName()}" />
        </div>
        <!-- Default to lead applicant when unassigned.  TODO: Maybe we need to indicate visually in someway that this has not been actually assigned by defaulting to it? -->
        <div th:remove="tag" th:if="${questionAssignee?.getAssignee() == null} ">
            Assigned to: <strong th:text="${name}" th:with="name=${(leadApplicant?.getUser()?.getId() == currentUser.getId()) ? 'You' : leadApplicant?.getUser()?.getName()}" />
        </div>
</div>

<!-- ========================= Last update info =========================== -->

<div  th:fragment="last-update-info">
        <div th:if="${response?.getUpdateDate()}" th:remove="tag"><small><span>Last updated: </span>
            <div th:include="fragments/elements :: pretty-date (date=${response?.getUpdateDate()})"
                 th:remove="tag"/>

            by
            <span th:if="${response?.getUpdatedBy()?.getUser()?.getId() == currentUser.getId()}" th:text="you"/>
            <span th:unless="${response?.getUpdatedBy()?.getUser()?.getId() == currentUser.getId()}" th:text="${response?.getUpdatedBy()?.getUser()?.getName()}"/>

        </small></div>
</div>

<!-- ========================= Mark as complete buttons =========================== -->

<div th:fragment="form-mark-as-complete-buttons">
    <!--/*
            TODO: the marks as complete button is hidden when in readonly,
            this because the controller on the readonly pages doesn't handle mark as complete yet,
            if the controller is fixed remove 'hidden' from th:class
     */-->
    <button th:if="${question.isMarkAsCompletedEnabled() and not markedAsComplete?.contains(question.id)}"
            type="submit"
            name="mark_as_complete"
            th:value="${question.getId()}"
            th:class="${readonly} or ${costCategory!=null} ? 'button' : 'buttonlink'"
            th:attrappend="formaction='&#35;question-'+${question.getId()}">Mark as complete
    </button>
    <button th:unless="${readonly}"
            th:if="${question.isMarkAsCompletedEnabled() and markedAsComplete?.contains(question.id)}"
            type="submit"
            name="mark_as_incomplete"
            th:value="${question.getId()}"
            th:class="${costCategory!=null} ? 'button' : 'buttonlink'"
            th:attrappend="formaction='&#35;question-'+${question.getId()}">Edit
    </button>

</div>
<!-- ========================= edit link =========================== -->

<div th:fragment="form-edit-question-button">
    <a tabindex="0"
       class="button-secondary"
       th:href="'/application/'+${currentApplication.getId()}+'/form/question/edit/'+${question.getId()}"
       th:text="Edit"/>
</div>

<!-- ========================= word count =========================== -->

<div th:fragment="form-word-count (maxWords, currentWordsLeft)">
    <div th:unless="${maxWords == 0}" th:remove="tag">
		<span class="count-label">
				<span class="count-message">Words remaining:</span>
				<span class="count-down" aria-live="polite" th:if="${currentWordsLeft}" th:text="${currentWordsLeft}" th:classappend="${currentWordsLeft &lt; 0}? negative : positive" >0</span>
				<span class="count-down" aria-live="polite" th:unless="${currentWordsLeft}" th:text="${maxWords}" th:classappend="${maxWords &lt; 0}? negative : positive" >0</span>
		</span>
    </div>
</div>
</html>
