<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<!-- id of the competition for in the page title -->
<!-- TODO: Why ask for competition object when all you need is id here?  Can you please ask for just two value parameters instead?  It simplifies view model: -->
<div th:fragment="competition-id(competition)" th:remove="tag">
    <div th:include="fragments/competition-management :: competition-id-simple(${competition.competitionId})" th:remove="tag" />
</div>

<!-- TODO: Following on from previous to do, we can do it like this: -->
<div th:fragment="competition-id-simple(competitionId)" th:remove="tag">
    <p class="subtitle"><div th:text="${#numbers.formatInteger(competitionId,8)}" th:remove="tag" /> : Innovate UK</p>
</div>

<!-- competition status with blue block -->
<div th:fragment="competition-status(competition)" th:remove="tag">
    <div th:unless="${competition == 'setup'}" th:remove="tag">
      <h2 th:switch="${competition.competitionStatus.name()}" class="bold-small blue-block">
          <div th:remove="tag" th:case="'NOT_STARTED'">Competition not yet started</div>
          <div th:remove="tag" th:case="'OPEN'">Competition open</div>
          <div th:remove="tag" th:case="'IN_ASSESSMENT'">In assessment</div>
          <div th:remove="tag" th:case="'FUNDERS_PANEL'">Funders Panel</div>
          <div th:remove="tag" th:case="'ASSESSOR_FEEDBACK'">Assessor Feedback</div>
          <div th:remove="tag" th:case="'PROJECT_SETUP'">Project setup</div>
          <div th:remove="tag" th:case="*">test2</div>
      </h2>
    </div>
    <div th:if="${competition == 'setup'}" th:remove="tag">
        <h2 class="bold-small blue-block">Competition Setup</h2>
    </div>
</div>


<!-- competition management menu -->
<div th:fragment="competition-mgt-menu(competitionStatus,competitionId)" th:remove="tag">

    <div th:switch="${competitionStatus}" th:remove="tag">

        <div th:remove="tag" th:case="'OPEN'">
          <div th:include="fragments/competition-management :: competition-mgt-menu-open(id=${competitionId})" th:remove="tag" />
        </div>

        <div th:remove="tag" th:case="'IN_ASSESSMENT'">
          <div th:include="fragments/competition-management :: competition-mgt-menu-assessment(id=${competitionId})" th:remove="tag" />
        </div>
        <div th:remove="tag" th:case="'FUNDERS_PANEL'">
        	<div th:include="fragments/competition-management :: competition-mgt-menu-assessment(id=${competitionId})" th:remove="tag" />
        </div>
        <div th:remove="tag" th:case="'ASSESSOR_FEEDBACK'">
        	<div th:include="fragments/competition-management :: competition-mgt-menu-assessor-feedback(id=${competitionId})" th:remove="tag" />
        </div>
        <!--/* future
        <div th:remove="tag" th:case="'PROJECT_SETUP'"></div>
        */-->
    </div>
</div>

<div th:fragment="competition-mgt-menu-assessor-feedback(id)" th:remove="tag">
  <ul class="inline-nav extra-margin">
    <li th:class="${activeTab == 'overview' ? 'selected':''}"><a th:href="${'/management/competition/' + id + '?tab=overview'}">Overview</a></li>
    <li th:class="${activeTab == 'submitted' ? 'selected':''}"><a th:href="${'/management/competition/' + id + '?tab=submitted'}">Applications submitted</a></li>
    <li th:class="${activeTab == 'notSubmitted' ? 'selected':''}"><a th:href="${'/management/competition/' + id + '?tab=notSubmitted'}">Applications not submitted</a></li>
  </ul>
</div>

<div th:fragment="competition-mgt-menu-assessment(id)" th:remove="tag">
  <ul class="inline-nav extra-margin">
    <li th:class="${activeTab == 'submitted' ? 'selected':''}"><a th:href="${'/management/competition/' + id + '?tab=submitted'}">Applications submitted</a></li>
    <li th:class="${activeTab == 'notSubmitted' ? 'selected':''}"><a th:href="${'/management/competition/' + id + '?tab=notSubmitted'}">Applications not submitted</a></li>
  </ul>
</div>

<div th:fragment="competition-mgt-menu-open(id)" th:remove="tag">
  <ul class="inline-nav extra-margin">
    <li th:class="${activeTab == 'allApplications' ? 'selected':''}"><a th:href="${'/management/competition/'+id}">All applications</a></li>
  </ul>
</div>

<!-- Box with summary about competition on left hand side -->
<div th:remove="tag" th:fragment="info-area" class="bold-small blue-block">
    <div th:switch="${competitionSummary.competitionStatus.name()}">

      <div th:case="'NOT_STARTED'" class="info-area boxed">
              <p>This competition has not yet been started.</p>
      </div>

      <div th:case="'OPEN'"  class="info-area boxed">
          <p>
          <span class="bold-medium">
            <div th:include="fragments/elements :: ordinal-day (date=${competitionSummary.getApplicationDeadline()})" th:remove="tag" />
            <div th:remove="tag" th:text="${#temporals.format(competitionSummary.getApplicationDeadline(), 'MMMM yyyy')}" />
          </span> Application deadline
          </p>
          <p><span class="bold-medium" th:text="${competitionSummary.totalNumberOfApplications}" /> Total number of applications</p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsStarted}" /> Applications started</p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsInProgress}" /> Applications in progress (Beyond 50%)</p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsSubmitted}" /> Applications submitted</p>
      </div>

      <div th:case="'IN_ASSESSMENT'" class="info-area boxed">
          <p>
          <span class="bold-medium">
            <div th:include="fragments/elements :: ordinal-day (date=${competitionSummary.getApplicationDeadline()})" th:remove="tag" />
            <div th:remove="tag" th:text="${#temporals.format(competitionSummary.getApplicationDeadline(), 'MMMM yyyy')}" />
          </span> Application deadline
          </p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsSubmitted}" /> Applications submitted</p>
          <p th:if="${param.tab != null} and ${param.tab[0] == 'notSubmitted'}"><span class="bold-medium" th:text="${competitionSummary.applicationsNotSubmitted}"/> Applications not submitted</p>
          <p th:if="${param.tab != null} and ${param.tab[0] == 'submitted'}"><a th:href="'/management/competition/'+${competitionSummary.competitionId}+'/download'" class="button-secondary">Export application data (.xls)</a></p>
      </div>

      <div th:case="'FUNDERS_PANEL'" class="info-area boxed">
          <p>
          <span class="bold-medium">
            <div th:include="fragments/elements :: ordinal-day (date=${competitionSummary.getApplicationDeadline()})" th:remove="tag" />
            <div th:remove="tag" th:text="${#temporals.format(competitionSummary.getApplicationDeadline(), 'MMMM yyyy')}" />
          </span> Assessment deadline
          </p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsSubmitted}" /> Applications submitted</p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsNotSubmitted}" /> Applications not submitted</p>
          <a th:href="'/management/competition/'+${competitionSummary.competitionId}+'/download'" class="button-secondary no-margin-right">Export application data (.xls)</a>
          <label for="notify-applicants" role="button" class="button no-margin-right" id="publish-funding-decision" data-js-modal="modal-publish-funding-decision">Notify applicants</label>

          <div th:include="fragments/modals :: modal-overlay" th:remove="tag" />
      </div>

      <div th:case="'ASSESSOR_FEEDBACK'" class="info-area boxed">
          <p>
          <span class="bold-medium">
            <div th:include="fragments/elements :: ordinal-day (date=${competitionSummary.getApplicationDeadline()})" th:remove="tag" />
            <div th:remove="tag" th:text="${#temporals.format(competitionSummary.getApplicationDeadline(), 'MMMM yyyy')}" />
          </span> Assessment deadline
          </p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsSubmitted}" /> Applications submitted</p>
          <p th:if="${activeTab == 'notSubmitted'}"><span class="bold-medium" th:text="${competitionSummary.applicationsNotSubmitted}" /> Applications not submitted</p>
          <p th:if="${activeTab == 'submitted'}"><span class="bold-medium" th:text="${competitionSummary.applicationsFunded}" /> Funded</p>


          <form method="post" th:action="@{/competition/{competitionId}/assessorfeedback(competitionId=${competitionSummary.getCompetitionId()})}">
            <button th:disabled="${!canPublishAssessorFeedback}" class="button no-margin-right" th:if="${activeTab == 'submitted'}" data-js-modal="modal-submit-assessor-feedback">Publish assessor feedback</button>
          </form>
          <div th:include="fragments/modals :: modal-overlay" th:remove="tag" />

      </div>

      <div th:case="'PROJECT_SETUP'" class="info-area boxed">
          <p>
          <span class="bold-medium">
            <div th:include="fragments/elements :: ordinal-day (date=${competitionSummary.getApplicationDeadline()})" th:remove="tag" />
            <div th:remove="tag" th:text="${#temporals.format(competitionSummary.getApplicationDeadline(), 'MMMM yyyy')}" />
          </span> Application deadline
          </p>
          <p><span class="bold-medium" th:text="${competitionSummary.totalNumberOfApplications}" /> Total number of applications</p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsStarted}" /> Applications started</p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsInProgress}" /> Applications in progress (Beyond 50%)</p>
          <p><span class="bold-medium" th:text="${competitionSummary.applicationsSubmitted}" /> Applications submitted</p>
      </div>

        &nbsp; <!--/* don't remove is for mainting layout when the info box is sticky/fixed */-->
    </div>

</div>

<!-- Applications table -->
<div th:fragment="applications-table(competition,results)" th:remove="tag">
   <table th:if="${competition.competitionStatus.name() == 'OPEN'}">
     <thead>
       <tr>
         <th scope="col">Application no</th>
         <th scope="col">Project title</th>
         <th scope="col">Lead name</th>
         <th scope="col">Lead</th>
         <th scope="col">Status</th>
         <th scope="col">Percentage complete</th>
       </tr>
     </thead>
     <tbody>
       <tr th:each="result : ${results.content}">
         <td><a th:href="${'/management/competition/' + competition.competitionId + '/application/' + result.id}" th:text="${result.getFormattedId()}" /></td>
         <td th:text="${result.name}"></td>
         <td th:text="${result.leadApplicant}"></td>
         <td th:text="${result.lead}"></td>
         <td th:text="${result.status}"></td>
         <td th:text="${result.completedPercentage}"></td>
       </tr>
     </tbody>
   </table>

   <div th:if="${competition.competitionStatus.name() == 'IN_ASSESSMENT' or competition.competitionStatus.name() == 'FUNDERS_PANEL' or competition.competitionStatus.name() == 'ASSESSOR_FEEDBACK'}" th:remove="tag">
	    <table th:if="${activeTab == 'submitted'}">
	       <thead>
	         <tr>
	           <th scope="col">Application no</th>
	           <th scope="col">Project title</th>
	           <th scope="col">Lead</th>
	           <th scope="col">No. of partners</th>
	           <th scope="col">Grant requested (£)</th>
	           <th scope="col">Total project cost (£)</th>
	           <th scope="col">Duration (months)</th>
	           <th scope="col" id="fund-project-label" th:if="${competition.competitionStatus.name() == 'FUNDERS_PANEL'}">Fund project?</th>
	           <th scope="col" id="fund-project-label" th:if="${competition.competitionStatus.name() == 'ASSESSOR_FEEDBACK'}">Funded</th>
             <th scope="col" th:if="${competition.competitionStatus.name() == 'FUNDERS_PANEL'}"><span class="visuallyhidden">Save status</span></th>
	         </tr>
	       </thead>
	       <tbody>
	         <tr th:each="result : ${results.content}"  th:class="${competition.competitionStatus.name() == 'FUNDERS_PANEL' ? 'form-group' : ''}">
	           <td><a th:href="${'/management/competition/' + competition.competitionId + '/application/' + result.id}"  th:text="${#numbers.formatInteger(result.id,8)}"/></td>
	           <td th:text="${result.name}"></td>
	           <td th:text="${result.lead}"></td>
	           <td th:text="${result.numberOfPartners}"></td>
	           <td th:text="${result.grantRequested}"></td>
	           <td th:text="${result.totalProjectCost}"></td>
	           <td th:text="${result.duration}"></td>
	           <td scope="col" th:if="${competition.competitionStatus.name() == 'FUNDERS_PANEL'}">
	          	 <select class="funding-decision form-control" aria-labelledby="fund-project-label" th:id="${'fund' + result.id}" th:name="${result.id}" th:attr="data-competition=${competition.competitionId}">
           			<option th:selected="${result.fundingDecision == null || result.fundingDecision.name() == 'UNDECIDED'}" value="-">-</option>
           			<option th:selected="${result.fundingDecision?.name() == 'FUNDED'}" value="Y">Yes</option>
           			<option th:selected="${result.fundingDecision?.name() == 'UNFUNDED'}" value="N">No</option>
           		  </select>
	           </td>
	           <td scope="col" th:if="${competition.competitionStatus.name() == 'ASSESSOR_FEEDBACK'}" >
	           		<span th:if="${result.isFunded()}" th:remove="tag">Yes</span>
	           		<span th:unless="${result.isFunded()}" th:remove="tag">No</span>
	           </td>
             <td th:if="${competition.competitionStatus.name() == 'FUNDERS_PANEL'}" class="autosave-info"></td>
	         </tr>
	       </tbody>
	     </table>

	     <table th:if="${activeTab == 'notSubmitted'}">
	       <thead>
	         <tr>
	           <th scope="col">Application no</th>
	           <th scope="col">Project title</th>
	           <th scope="col">Lead</th>
	           <th scope="col">Percentage complete</th>
	         </tr>
	       </thead>
	       <tbody>
	         <tr th:each="result : ${results.content}">
	           <td><a th:href="${'/management/competition/' + competition.competitionId + '/application/' + result.id}"  th:text="${#numbers.formatInteger(result.id,8)}"/></td>
	           <td th:text="${result.name}"></td>
	           <td th:text="${result.lead}"></td>
	           <td th:text="${result.completedPercentage}"></td>
	         </tr>
	       </tbody>
	     </table>
     </div>

</div>

<!-- Applications pagination -->
<div th:fragment="applications-pagination(results)" th:remove="tag">
	<div class="pagination" th:if="${results.hasPrevious() or results.hasNext()}">
      <button class="prev" th:if="${results.hasPrevious()}" type="submit" name="page" th:value="${results.number}">Prev</button>
      <div class="status">
        Page <span th:text="${results.number + 1}"></span> of <span th:text="${results.totalPages}"></span>
      </div>
      <button class="next" th:if="${results.hasNext()}" type="submit" name="page" th:value="${results.number + 2}">Next</button>
    </div>
</div>

<!-- Applications sort -->
<div th:fragment="applications-sort(activeTab, activeSortField)" th:remove="tag">
	<label for="sort-by">Sort by</label>
    <select id="sort-by" name="sort" class="js-auto-submit form-control" th:if="${activeTab == 'submitted'}">
        <option value="id" th:selected="${(activeSortField == 'id')}">Application no.</option>
        <option value="name" th:selected="${(activeSortField == 'name')}">Project title</option>
        <option value="lead" th:selected="${(activeSortField == 'lead')}">Lead</option>
        <option value="numberOfPartners" th:selected="${(activeSortField == 'numberOfPartners')}">No. of partners</option>
        <option value="grantRequested" th:selected="${(activeSortField == 'grantRequested')}">Grant requested</option>
        <option value="totalProjectCost" th:selected="${(activeSortField == 'totalProjectCost')}">Total project cost</option>
        <option value="duration" th:selected="${(activeSortField == 'duration')}">Duration</option>

    </select>
    <select id="sort-by" name="sort" class="js-auto-submit form-control" th:if="${activeTab == 'notSubmitted'}">
        <option value="id" th:selected="${(activeSortField == 'id')}">Application no.</option>
        <option value="name" th:selected="${(activeSortField == 'name')}">Project title</option>
        <option value="lead" th:selected="${(activeSortField == 'lead')}">Lead</option>
        <option value="percentageComplete" th:selected="${(activeSortField == 'percentageComplete')}">Percentage complete</option>
    </select>
    <button type="submit" class="button button-secondary no-margin">Sort</button>
</div>
</html>
