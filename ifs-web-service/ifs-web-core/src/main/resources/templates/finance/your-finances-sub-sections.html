<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml" xmlns:ifs="http://www.w3.org/1999/xhtml">

    <!-- ===========================Your finances section view =========================== -->
    <th:block th:fragment="your_finances">
        <th:block th:if="${model.currentSection.type == T(org.innovateuk.ifs.application.resource.SectionType).FINANCE}">
            <div class="your-finances">
                <h2 class="heading-medium no-margin-bottom">Finances</h2>
                <p>Please complete your project finances.</p>

                <details class="extra-margin-bottom" th:attr="open=${model.notRequestingFunding ? 'open' : null}">
                    <summary><span class="summary">Not requesting funding</span></summary>
                    <div class="panel-indent">
                        <p>If your organisation is not funded by Innovate UK then you do not need to submit organisational or funding details. <span th:unless="${model.notRequestingFunding}">Please confirm below.</span></p>
                        <button th:unless="${model.notRequestingFunding}" class="button" name="not_requesting_funding">Not requesting funding</button>
                        <button th:if="${model.notRequestingFunding}" class="button" name="requesting_funding">Requesting funding</button>
                    </div>
                </details>
                <ul class="list-overview extra-margin">
                    <th:block th:each="subSection : ${model.subSections.get(model.currentSection.id)}">
                        <th:block th:if="${model.isSectionDisplayed(subSection)}" th:insert="finance/your-finances-sub-sections :: finance_sub_section_row" />
                    </th:block>
                </ul>
            </div>

            <h2 class="heading-medium">Finance summary</h2>
            <p>This is a breakdown of your project costs and sources of funding for this project.</p>
            <div th:include="finance/your-finances-sub-sections :: your_finance_summary"/>

        </th:block>
    </th:block>


    <!-- =========================== Your organisation =========================== -->
    <th:block th:fragment="your_organisation">
        <th:block th:with="markedAsComplete=(${model.application.markedAsComplete}),
                           organisationFinanceSize=(${model.finance.organisationFinanceSize})">
            <div class="question" th:each="formInput, status : ${model.getFormInputsOrganisationSize(question.id)}" th:id="'form-input-'+${formInput.getId()}">
                <th:block th:if="${formInput.type.isDisplayableFinanceType(model.finance.financeView) and model.finance.hasOrganisationFinance}">
                    <div th:replace="'finance/'+${model.finance.financeView} :: organisation_size" />
                </th:block>
            </div>

            <div class="question" th:each="formInput, status : ${model.getFormInputsFinancialEndYear(question.id)}" th:id="'form-input-'+${formInput.getId()}">
                <th:block th:if="${formInput.type.isDisplayableFinanceType(model.finance.financeView) and model.finance.hasOrganisationFinance}">
                    <div th:replace="'finance/'+${model.finance.financeView} :: financial_year_end" />
                </th:block>
            </div>

            <fieldset>
                <legend class="heading-medium no-margin-bottom">Financial overview</legend>
                <span class="form-hint">Details relating to your organisation over the last financial year.</span><br>
                <div class="grid-row">
                    <div class="column-half">
                        <table class="extra-margin-bottom">
                            <thead>
                                <tr>
                                    <th scope="col">Section</th>
                                    <th scope="col" class="numeric" id="last-year">Last financial year (Â£)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="formInput, status : ${model.getFormInputsFinancialOverview(question.id)}" th:classappend="${#fields.hasErrors('formInput[__${formInput.id}__]')} ? 'error' : ''" class="form-group">
                                    <td>
                                        <label th:for="${'input-'+formInput.id}">
                                            <span th:text="${formInput.description}"></span>
                                            <th:block th:include="question-type/form-elements :: form-validation-messages (id=${formInput.id})" />
                                        </label>
                                    </td>
                                    <td class="numeric">
                                        <input class="form-control width-small"
                                               th:disabled="${readonly or (question.isMarkAsCompletedEnabled() and model.application.markedAsComplete?.contains(question.id))}"
                                               th:id="${'input-'+formInput.id}"
                                               th:name="'formInput['+${formInput.id}+']'"
                                               th:value="*{formInput[__${formInput.id}__]}"
                                               th:classappend="${#fields.hasErrors('formInput[__${formInput.id}__]')} ? 'field-error' : ''"
                                               required="required"
                                               min="-2147483647"
                                               max="2147483647"
                                               type="number"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </fieldset>
            <div class="question" th:each="formInput, status : ${model.getFormInputsFinancialStaffCount(question.id)}" th:id="'form-input-'+${formInput.getId()}">
                <th:block th:if="${formInput.type.isDisplayableFinanceType(model.finance.financeView) and model.finance.hasOrganisationFinance}">
                    <div th:replace="'finance/'+${model.finance.financeView} :: staff_count" />
                </th:block>
            </div>
        </th:block>
    </th:block>

    <!-- ===========================Your finances agree terms view =========================== -->
    <th:block th:fragment="agree_terms">
        <th:block th:if="${(model.application.currentCompetition.isOpen())} and ${null != model.currentSection}"
            th:with="currentSection=(${model.currentSection}), completedSections=(${model.completedSections})">
            <th:block th:if="${model.showAgreeToStateAidOption}">
                <div th:insert="fragments/elements :: application-agree-to-state-aid" th:with="fieldName='form.stateAidAgreed'" class="agree-to-terms-container"></div>
            </th:block>
            <th:block th:if="${model.showAgreeToTermsOption}">
                <div th:insert="fragments/elements :: application-agree-to-terms" th:with="fieldName='form.termsAgreed'" class="agree-to-terms-container"></div>
            </th:block>
        </th:block>
    </th:block>


    <!-- ===========================Subsection buttons =========================== -->
    <th:block th:fragment="subsection_buttons">
        <th:block th:if="${model.subFinanceSection}">
            <div>
                <button id="mark-all-as-complete" th:unless="${model.sectionsMarkedAsComplete.contains(model.currentSection.id)}" type="submit" name="mark_section_as_complete" class="button">Mark as complete</button>
                <button th:if="${model.sectionsMarkedAsComplete.contains(model.currentSection.id)}" type="submit" name="mark_section_as_incomplete" class="extra-margin buttonlink"
                        th:text="${'Edit ' + #strings.toLowerCase(model.currentSection.name)}">Edit</button>
            </div>
            <div>
                <a th:href="@{/application/{id}/form/section/{sectionId}(id=${model.application.currentApplication.id}, sectionId=${model.currentSection.getParentSection()})}" class="button-secondary extra-margin">
                    Return to finances
                </a>
            </div>
        </th:block>
    </th:block>

    <th:block th:fragment="finance_sub_section_row">

        <li class="grid-row section">
            <th:block th:if="${model.showSectionAsNotRequired(subSection)}">
                <div class="column-half">
                    <h3 class="heading-small" th:text="${subSection.name}"></h3>
                </div>
                <div class="column-half alignright">
                    <span class="form-hint">Not required</span>
                </div>
            </th:block>
            <th:block th:unless="${model.showSectionAsNotRequired(subSection)}">
                <div class="column-one">
                    <th:block th:if="${model.showSectionAsLink(subSection)}">
                        <h3 class="heading-small">
                            <a  th:href="@{/application/{id}/form/section/{sectionId}(id=${model.application.currentApplication.id},sectionId=${subSection.id})}"
                                th:text="${subSection.name}"></a>
                        </h3>
                    </th:block>
                    <th:block th:if="${model.showSectionAsLockedFunding(subSection)}">
                        <h3 class="heading-small" th:text="${subSection.name}"></h3>
                        <p>You must select a research category in <a th:href="@{/application/{id}/form/question/{questionId}(id=${model.application.currentApplication.id}, questionId=${model.applicationDetailsQuestionId})}">application details</a> before you can supply funding. You must also state your organisation size in the <a th:href="@{/application/{id}/form/section/{sectionId}(id=${model.application.currentApplication.id}, sectionId=${model.yourOrganisationSectionId})}">your organisation</a> section.</p>
                    </th:block>
                </div>
                <th:block th:if="${model.showSectionStatus(subSection)}">
                    <img class="section-status complete"
                         src="/images/field/field-done-right.png"
                         th:src="${@mvcResourceUrlProvider.getForLookupPath('/images/field/field-done-right.png')}"
                         width="30"
                         height="30"
                         th:alt="'The &quot;'+${subSection.getName()}+'&quot; section is marked as done'"
                         th:title="'The &quot;'+${subSection.getName()}+'&quot; section is marked as done'"
                         th:if="${model.sectionsMarkedAsComplete.contains(subSection.id)}"/>
                    <img class="section-status assigned"
                         src="/images/field/field-assigned-right.png"
                         th:src="${@mvcResourceUrlProvider.getForLookupPath('/images/field/field-assigned-right.png')}"
                         width="30"
                         height="30"
                         th:alt="'The &quot;'+${subSection.getName()}+'&quot; section is assigned to you'"
                         th:title="'The &quot;'+${subSection.getName()}+'&quot; section is assigned to you'"
                         th:unless="${model.sectionsMarkedAsComplete.contains(subSection.id)}"/>
                </th:block>
            </th:block>
        </li>
    </th:block>

    <th:block th:fragment="your_finance_summary">

        <div class="form-group" style="overflow:auto;">
            <table th:with="organisationId=${model.application.userOrganisation.id},
                            hasOrganisationFinance=${model.financeOverview.hasFinancesForOrganisation(organisationId)}">
                <thead>
                <tr>
                    <th scope="col" class="numeric width-small">Total project costs</th>
                    <th scope="col" class="numeric width-small">% Grant</th>
                    <th scope="col" class="numeric width-small">Funding sought</th>
                    <th scope="col" class="numeric width-small">Other public sector funding</th>
                    <th scope="col" class="numeric width-small">Contribution to project</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                <div th:if="${hasOrganisationFinance}"
                     th:with="organisationFinance=${model.financeOverview.organisationFinances.get(organisationId)}" th:remove="tag">
                    <td class="numeric">â¨
                        <strong th:text="'Â£'+${#numbers.formatDecimal(organisationFinance.total, 0, 'COMMA', 0, 'POINT')}" />â¨
                    </td>â¨
                    <td class="numeric" th:text="${organisationFinance.grantClaimPercentage}+'%'"/>â¨
                    <td class="numeric" th:text="'Â£'+${#numbers.formatDecimal(organisationFinance.totalFundingSought, 0, 'COMMA', 0, 'POINT')}"/>â¨
                    <td class="numeric" th:text="'Â£'+${#numbers.formatDecimal(organisationFinance.totalOtherFunding, 0, 'COMMA', 0, 'POINT')}"/>â¨
                    <td class="numeric" th:text="'Â£'+${#numbers.formatDecimal(organisationFinance.totalContribution, 0, 'COMMA', 0, 'POINT')}"/>â¨
                </div>
                <div th:unless="${hasOrganisationFinance}" th:remove="tag">
                    <td class="numeric">
                        <strong>&pound;0</strong>
                    </td>
                    <td class="numeric">0%</td>
                    <td class="numeric">&pound;0</td>
                    <td class="numeric">&pound;0</td>
                    <td class="numeric">&pound;0</td>
                </div>
                </tr>
                </tbody>
            </table>
        </div>
    </th:block>

</html>
