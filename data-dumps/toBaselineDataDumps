#!/bin/bash

#1) Create a database dump from the latest flyway
cd ../ifs-data-service/
./gradlew flywayClean flywayMigrate;
cd ../data-dumps/
mysqldump --no-data --add-drop-table -uifs -pifs ifs --ignore-table=ifs.schema_version > original_schema_only.sql
mysqldump --no-create-info --extended-insert=false -uifs -pifs ifs application_status cost_field form_input_type form_input_validator form_validator role > original_reference_data_only.sql
mysqldump --no-create-info --extended-insert=false -uifs -pifs ifs --ignore-table=ifs.application_status --ignore-table=ifs.cost_field --ignore-table=ifs.form_input_type --ignore-table=ifs.form_input_validator --ignore-table=ifs.form_validator --ignore-table=ifs.role --ignore-table=ifs.schema_version > original_test_data_only.sql
#2) Baseline the scripts
cd ../ifs-data-service/src/main/resources/db/migration/
rm -rf *
cp ../../../../../../data-dumps/original_schema_only.sql V1__BaseVersion.sql
cp ../../../../../../data-dumps/original_reference_data_only.sql V2__ReferenceData.sql
#3) Drop the old database
mysql -uifs -pifs -e"DROP DATABASE ifs"
mysql -uifs -pifs -e"CREATE DATABASE ifs DEFAULT CHARACTER SET utf8"
#3) Run the migration
cd ../../../../../
./gradlew flywayMigrate
#4) Apply the original test data to the new database
cd ../data-dumps/
mysql -uifs -pifs ifs < original_test_data_only.sql
#5) Export the database this is the baseline for a test environment
mysqldump --add-drop-table --extended-insert=false ifs -uifs -pifs > new_database_with_test_data.sql
#6) Regenerate the acceptance tests database
#TODO
#7) Run the integration tests.
#TODO


















#========
#=REVERT=
#========
# cd ifs-data-service
# git checkout src/main/resources/db/migration/V10_1__Cleanup_question_status_table.sql src/main/resources/db/migration/V10_2__UpdateWordCount.sql src/main/resources/db/migration/V1__Base_version.sql src/main/resources/db/migration/V2_10__MakeOriginalFirstPriorityQuestionsAssessable.sql src/main/resources/db/migration/V2_1__Add_Form_Input_Tables.sql src/main/resources/db/migration/V2_2__Migrate_Questions_To_Form_Inputs.sql src/main/resources/db/migration/V2_3__Migrate_Responses_To_Form_Input_Responses.sql src/main/resources/db/migration/V2_4__RemoveChildQuestions.sql src/main/resources/db/migration/V2_5__RemoveQuestionTypes.sql src/main/resources/db/migration/V2_6__DropChildQuestions.sql src/main/resources/db/migration/V2_7__RemoveValuesFromQuestionsAndResponses.sql src/main/resources/db/migration/V2_8__AddIncludedInApplicationSummaryColumn.sql src/main/resources/db/migration/V2_9__AddDescriptionColumnToFormInput.sql src/main/resources/db/migration/V3_1__Add_Form_Input_Validator_Tables.sql src/main/resources/db/migration/V3_2__Add_Validators_For_Textarea.sql src/main/resources/db/migration/V3_3__Refactor_Validator_Link_Table.sql src/main/resources/db/migration/V3_4__Add_Textarea_Validations.sql src/main/resources/db/migration/V3_5__SetQuestionNameForCustomFinanceSummaryCompleteHandling.sql src/main/resources/db/migration/V4_1__Add_finances_default_values.sql src/main/resources/db/migration/V4_2__Add_finances_cost_fields.sql src/main/resources/db/migration/V4_3__Add_finances_default_values.sql src/main/resources/db/migration/V5_1__Update_section_names.sql src/main/resources/db/migration/V5_2__Update_competition_startdate.sql src/main/resources/db/migration/V5_3__AddWordCountValidatorToFormInputs.sql src/main/resources/db/migration/V5_4__AddShortTitlesForQuestions.sql src/main/resources/db/migration/V5_5__UpdateQuestionsAssignmentToSections.sql src/main/resources/db/migration/V6_1__AddDirectUserOrganisationRelationship.sql src/main/resources/db/migration/V6_2__AddColumnsToUser.sql src/main/resources/db/migration/V6_3__UpdateShortTitlesWithoutNumbers.sql src/main/resources/db/migration/V6_4__UpdateQuestionsAssignmentToSections.sql src/main/resources/db/migration/V6_5__GroupQuestionsBySection.sql src/main/resources/db/migration/V7_1__Create_organisation_address_table.sql src/main/resources/db/migration/V7_2__Add_address_attribute.sql src/main/resources/db/migration/V7_3__Assign_questions_correctly.sql src/main/resources/db/migration/V7_4__Remove_question_numbers.sql src/main/resources/db/migration/V7_5__Update_Grant_Percentage_Question.sql src/main/resources/db/migration/V7_6__Update_Questions_Priority.sql src/main/resources/db/migration/V8_1__Add_FileEntry_Table.sql src/main/resources/db/migration/V8_2__Add_FileEntryId_Column_To_FormInputResponse.sql src/main/resources/db/migration/V8_3__Update_Other_Funding.sql src/main/resources/db/migration/V8_5__UpdateCompetitionDeadline.sql src/main/resources/db/migration/V9_1__RefactorProcesses.sql src/main/resources/db/migration/V9_2__Update_question_mark_as_done.sql src/main/resources/db/migration/V9_3__Update_question_mark_as_done.sql
# rm src/main/resources/db/migration/V1__BaseVersion.sql
# rm src/main/resources/db/migration/V2__ReferenceData.sql
# cd ../data-dumps
# rm new_database_with_test_data.sql original_reference_data_only.sql original_schema_only.sql reference_data_only.sql schema_only.sql original_test_data_only.sql
# Drop the integration test database
#mysql -uifs -pifs -e"DROP DATABASE ifs_test"
#mysql -uifs -pifs -e"CREATE DATABASE ifs_test DEFAULT CHARACTER SET utf8"






